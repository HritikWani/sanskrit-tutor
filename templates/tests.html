{% extends "base.html" %}
{% block title %}Tests{% endblock %}

{% block content %}
<div class="container">
  <h2>
    {% if session['role'] == 'admin' %}All Tests{% else %}Today's Test{% endif %}
  </h2>

  {% if can_add %}
    <a href="/admin/add-test"><button>Add Test</button></a>
  {% endif %}
  <br><hr><br>

  {% if tests %}
  <div class="table-responsive">
  <table>
    <thead>
      <tr>
        <th>Subject</th>
        <th>Class</th>
        <th>School</th>
        <th>Date</th>
        <th>Description</th>
        <th>Question Paper</th>
        {% if session['role'] == 'student' %}
          <th>Answer</th>
          <th>Marks</th>
          <th>Feedback</th>
        {% elif can_add %}
          <th>Action</th>
          <th>View</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for t in tests %}
      <tr>
        <td>{{ t.subject }}</td>
        <td>{{ t.class }}</td>
        <td>{{ t.school }}</td>
        <td>{{ t.test_date.strftime('%d-%m-%Y') }}</td>
        <td>{{ t.description or 'â€”' }}</td>
        <td>
          {% if t.question_paper %}
            <a href="{{ t.question_paper }}" target="_blank">View</a>
          {% else %}
            Not Uploaded
          {% endif %}
        </td>

        {% if session['role'] == 'student' %}
          <td>
            {% if uploaded_answers[t._id|string] %}
              <a href="{{ uploaded_answers[t._id|string].file_url }}" target="_blank">ðŸ“„ View</a>
            {% else %}
              <form action="/student/upload-answer/{{ t._id }}" method="POST" enctype="multipart/form-data">
                <input type="file" name="pdf_file" accept=".pdf" required>
                <button type="submit"><i class="fas fa-upload"></i>Upload</button>
              </form>
            {% endif %}
          </td>
          <td>
            {% set answer = uploaded_answers.get(t._id|string) %}
            {% if answer and answer.marks_obtained is defined %}
            {{ answer.marks_obtained }} / {{ t.max_marks }}

            {% else %}
              â€”
            {% endif %}
          </td>
          <td>
            {% if answer and answer.feedback %}
                {{ answer.feedback }}
            {% else %}
                â€”
            {% endif %}
          </td>

        {% elif can_add %}
          <td>
            <a href="/admin/delete-test/{{ t._id }}" onclick="return confirm('Delete this test?')">Delete</a>
          </td>
          <td>
            <a href="/admin/submitted-answers?test_id={{ t._id }}">View Submissions</a>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
  {% else %}
    <p>No {{ 'tests available' if session['role'] == 'admin' else 'test assigned for today' }}.</p>
  {% endif %}
  <br>
    {% if can_add %}
    <a href="/admin/dashboard"><button>â¬… Back to Dashboard</button></a>
    {% else %}
    <a href="/student/dashboard"><button>â¬… Back to Dashboard</button></a>
    {% endif %}
</div>
{% endblock %}
